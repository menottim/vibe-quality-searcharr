# Note: 'version' is obsolete in Docker Compose v2+ and has been removed

services:
  splintarr-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        VERSION: dev
    image: splintarr:dev
    container_name: splintarr-dev

    # Run as current user for file permissions
    # Note: Disabled for Windows compatibility - non-root user cannot write to
    # Windows volume mounts. Re-enable for Linux development environments.
    # user: "${UID:-1000}:${GID:-1000}"

    environment:
      # Application settings
      - APP_NAME=Splintarr-Dev
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG

      # Server configuration
      - HOST=0.0.0.0
      - PORT=7337
      - RELOAD=true  # Enable auto-reload for development

      # Secrets (use environment variables for dev convenience)
      # These are 32+ chars to pass config validation. DO NOT use in production.
      - SECRET_KEY=dev-only-insecure-secret-key-00000
      - PEPPER=dev-only-insecure-pepper-value-00000
      - DATABASE_KEY=dev-only-insecure-db-key-value-00

      # Database (in data volume)
      - DATABASE_URL=sqlite+pysqlcipher:///data/splintarr-dev.db?cipher=aes-256-cfb&kdf_iter=256000

      # Security settings (relaxed for development)
      - SESSION_EXPIRE_HOURS=24
      - ACCESS_TOKEN_EXPIRE_MINUTES=60
      - REFRESH_TOKEN_EXPIRE_DAYS=30

      # Rate limiting (more permissive for testing)
      - API_RATE_LIMIT=1000/minute

      # Network security (allow local instances for dev)
      - ALLOW_LOCAL_INSTANCES=true
      - ALLOWED_ORIGINS=http://localhost:7337,http://127.0.0.1:7337
      - ALLOWED_HOSTS=localhost,127.0.0.1

    volumes:
      # Mount source code for live reload
      - ../src:/app/src:rw
      - ../alembic:/app/alembic:rw
      - ../alembic.ini:/app/alembic.ini:ro
      # Data directory (persistent across restarts)
      - ../data:/data:rw
      # Temp directory
      - /tmp

    ports:
      # Expose to host for easy access
      - "7337:7337"
      # Optional: debugger port
      - "5678:5678"

    restart: unless-stopped

    # Health check (faster for dev)
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx, sys; resp = httpx.get('http://localhost:7337/health', timeout=5.0); sys.exit(0 if resp.status_code == 200 else 1)"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Resource limits (less restrictive for dev)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2G

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

    # Network
    networks:
      - vqs-dev-network

networks:
  vqs-dev-network:
    driver: bridge
