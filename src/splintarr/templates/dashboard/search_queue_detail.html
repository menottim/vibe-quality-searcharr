{% extends "base.html" %}

{% block title %}{{ queue.name }} - Search Queue - Splintarr{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ul>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/dashboard/search-queues">Search Queues</a></li>
        <li>{{ queue.name }}</li>
    </ul>
</nav>

<hgroup>
    <h1>{{ queue.name }}</h1>
    <p>
        {% if not queue.is_active %}
        <mark style="background: var(--muted-color); color: var(--muted-border-color);">Paused</mark>
        {% elif queue.status == 'failed' %}
        <mark style="background: var(--del-color);">Failed</mark>
        {% elif queue.status == 'completed' %}
        <mark style="background: var(--primary);">Completed</mark>
        {% elif queue.status in ['pending', 'in_progress'] %}
        <mark style="background: var(--ins-color);">Active</mark>
        {% else %}
        <mark>{{ queue.status }}</mark>
        {% endif %}
    </p>
</hgroup>

<!-- Queue Configuration -->
<article>
    <header><h3>Configuration</h3></header>
    <div class="grid">
        <div>
            <dl>
                <dt>Instance</dt>
                <dd>{{ queue.instance.name }} ({{ queue.instance.instance_type }})</dd>

                <dt>Strategy</dt>
                <dd><code>{{ queue.strategy }}</code></dd>

                <dt>Type</dt>
                <dd>
                    {% if queue.is_recurring %}
                    Recurring (every {{ queue.interval_hours }}h)
                    {% else %}
                    One-time
                    {% endif %}
                </dd>
            </dl>
        </div>
        <div>
            <dl>
                <dt>Next Run</dt>
                <dd>
                    {% if queue.next_run %}
                    {{ queue.next_run|timeago }}
                    {% else %}
                    Not scheduled
                    {% endif %}
                </dd>

                <dt>Last Run</dt>
                <dd>
                    {% if queue.last_run %}
                    {{ queue.last_run|timeago }}
                    {% else %}
                    Never
                    {% endif %}
                </dd>

                <dt>Consecutive Failures</dt>
                <dd>{{ queue.consecutive_failures }}</dd>
            </dl>
        </div>
    </div>

    {% if queue.error_message %}
    <div class="alert alert-danger" style="margin-top: 1rem;">
        <strong>Last Error:</strong> {{ queue.error_message }}
    </div>
    {% endif %}
</article>

<!-- Actions -->
<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
    {% if not queue.is_active %}
    <button data-action="resume-queue" data-id="{{ queue.id }}">Resume</button>
    {% else %}
    <button class="secondary" data-action="pause-queue" data-id="{{ queue.id }}">Pause</button>
    {% endif %}
    <button class="secondary" data-action="start-queue" data-id="{{ queue.id }}">Start Now</button>
    <button class="secondary" style="color: var(--del-color);" data-action="delete-queue" data-id="{{ queue.id }}" data-name="{{ queue.name }}">Delete</button>
    <a href="/dashboard/search-queues" role="button" class="secondary" style="margin-left: auto;">Back to Queues</a>
</div>

<!-- Execution History -->
<article>
    <header><h3>Execution History</h3></header>

    {% if history %}
    <figure>
        <table role="grid">
            <thead>
                <tr>
                    <th>Started</th>
                    <th>Status</th>
                    <th>Items Searched</th>
                    <th>Items Found</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in history %}
                <tr>
                    <td><small>{{ entry.started_at|timeago }}</small></td>
                    <td>
                        {% if entry.status == 'completed' %}
                        <span style="color: var(--ins-color);">Completed</span>
                        {% elif entry.status == 'running' %}
                        <span style="color: var(--primary);">Running</span>
                        {% elif entry.status == 'failed' %}
                        <span style="color: var(--del-color);">Failed</span>
                        {% else %}
                        {{ entry.status }}
                        {% endif %}
                    </td>
                    <td>{{ entry.items_searched or 0 }}</td>
                    <td>{{ entry.items_found or 0 }}</td>
                    <td>
                        {% if entry.duration_seconds %}
                        {{ entry.duration_seconds }}s
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>
    {% else %}
    <p style="text-align: center; color: var(--muted-color); padding: 2rem;">
        No execution history yet.
    </p>
    {% endif %}
</article>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    var action = target.dataset.action;
    if (action === 'resume-queue') resumeQueue(parseInt(target.dataset.id));
    else if (action === 'pause-queue') pauseQueue(parseInt(target.dataset.id));
    else if (action === 'start-queue') startQueue(parseInt(target.dataset.id));
    else if (action === 'delete-queue') deleteQueue(parseInt(target.dataset.id), target.dataset.name);
});

async function pauseQueue(queueId) {
    try {
        const response = await fetch(`/api/search-queues/${queueId}/pause`, { method: 'POST' });
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            showNotification('Failed to pause: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        showNotification('Failed to pause: ' + error.message);
    }
}

async function resumeQueue(queueId) {
    try {
        const response = await fetch(`/api/search-queues/${queueId}/resume`, { method: 'POST' });
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            showNotification('Failed to resume: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        showNotification('Failed to resume: ' + error.message);
    }
}

async function startQueue(queueId) {
    try {
        const btn = document.querySelector('[data-action="start-queue"]');
        btn.setAttribute('aria-busy', 'true');
        btn.disabled = true;

        const response = await fetch(`/api/search-queues/${queueId}/start`, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
            showNotification(data.message || 'Search started', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('Failed to start: ' + (data.detail || 'Unknown error'));
            btn.setAttribute('aria-busy', 'false');
            btn.disabled = false;
        }
    } catch (error) {
        showNotification('Failed to start: ' + error.message);
    }
}

async function deleteQueue(queueId, name) {
    if (!confirm(`Are you sure you want to delete queue "${name}"?`)) return;

    try {
        const response = await fetch(`/api/search-queues/${queueId}`, { method: 'DELETE' });
        if (response.ok) {
            window.location.href = '/dashboard/search-queues';
        } else {
            const data = await response.json();
            showNotification('Delete failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        showNotification('Delete failed: ' + error.message);
    }
}
</script>
{% endblock %}
