{% extends "base.html" %}

{% block title %}Dashboard - Splintarr{% endblock %}

{% block content %}
<hgroup>
    <h1>Dashboard</h1>
    <p>Overview of your Splintarr system</p>
</hgroup>

<!-- Statistics Cards -->
<div class="grid">
    <a href="/dashboard/search-queues" style="text-decoration: none; color: inherit;">
        <article>
            <hgroup>
                <h2 id="stat-queues-total">{{ stats.search_queues.total }}</h2>
                <p>Search Queues</p>
            </hgroup>
            <small>
                <span style="color: var(--ins-color);" id="stat-queues-active">{{ stats.search_queues.active }} active</span>
                {% if stats.search_queues.paused > 0 %}
                &middot; <span style="color: var(--muted-color);" id="stat-queues-paused">{{ stats.search_queues.paused }} paused</span>
                {% endif %}
            </small>
        </article>
    </a>

    <a href="/dashboard/search-history" style="text-decoration: none; color: inherit;">
        <article>
            <hgroup>
                <h2 id="stat-searches-today">{{ stats.searches.today }}</h2>
                <p>Searches Today</p>
            </hgroup>
            <small id="stat-searches-detail">{{ stats.searches.this_week }} this week &middot; {{ stats.searches.success_rate }}% success rate</small>
            {% if stats.searches.grab_rate and stats.searches.grab_rate > 0 %}
            <br><small id="stat-grab-rate" style="color: var(--muted-color);">{{ stats.searches.grab_rate }}% grab rate</small>
            {% else %}
            <br><small id="stat-grab-rate" style="color: var(--muted-color);"></small>
            {% endif %}
        </article>
    </a>

    <a href="/dashboard/library" style="text-decoration: none; color: inherit;">
        <article>
            <hgroup>
                <h2 id="stat-library-total">-</h2>
                <p>Library Items</p>
            </hgroup>
            <small id="stat-library-detail">Loading...</small>
        </article>
    </a>
</div>

<!-- Indexer Health (only shown if Prowlarr configured) -->
<div id="indexer-health-section" style="display: none;">
    <article>
        <header>
            <h3>Indexer Health</h3>
        </header>
        <div class="overflow-auto">
            <table id="indexer-health-table" role="grid">
                <thead>
                    <tr>
                        <th>Indexer</th>
                        <th>Query Limit</th>
                        <th>Queries Used</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="indexer-health-body">
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--muted-color);">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </article>
</div>

<!-- Recent Activity -->
<article>
    <header>
        <h3>Recent Search Activity</h3>
    </header>

    <figure>
        <table role="grid">
            <thead>
                <tr>
                    <th>Instance</th>
                    <th>Strategy</th>
                    <th>Status</th>
                    <th>Items</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="activity-tbody">
                {% if recent_searches %}
                {% for search in recent_searches %}
                <tr>
                    <td><a href="/dashboard/instances">{{ search.instance.name }}</a></td>
                    <td><code>{{ search.strategy }}</code></td>
                    <td>
                        {% if search.status == 'completed' %}
                        <span style="color: var(--ins-color);">✓ Completed</span>
                        {% elif search.status == 'running' %}
                        <span style="color: var(--primary);">⟳ Running</span>
                        {% elif search.status == 'failed' %}
                        <span style="color: var(--del-color);">✗ Failed</span>
                        {% else %}
                        <span style="color: var(--muted-color);">{{ search.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if search.searches_triggered %}
                        {{ search.searches_triggered }} searched
                        {% if search.items_found %}
                        of {{ search.items_found }} eligible
                        {% endif %}
                        {% else %}
                        {{ search.items_found or 0 }} eligible
                        {% endif %}
                    </td>
                    <td>
                        <small>{{ search.started_at|timeago }}</small>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--muted-color);">
                        No search history yet. <a href="/dashboard/search-queues">Create a search queue</a> to get started!
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </figure>

    <footer style="text-align: right;">
        <a href="/dashboard/search-history">View all history →</a>
    </footer>
</article>

<!-- Quick Actions & System Status -->
<div class="grid">
    <article>
        <h4>Quick Actions</h4>
        <p><a href="/dashboard/library">Browse Library</a></p>
        <p><a href="/dashboard/search-queues">Create Search Queue</a></p>
        <p><a href="/dashboard/instances">Add Instance</a></p>
        <p><a href="/dashboard/search-history">View History</a></p>
    </article>

    <article>
        <header>
            <h4 style="margin-bottom: 0;">System Status</h4>
            <small style="color: var(--muted-color);" id="system-status-timestamp">Last checked: just now</small>
        </header>

        <div id="system-status-content">
            {% if instances %}
            {% for instance in instances %}
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                {% if instance.connection_status == 'healthy' %}
                <span style="color: var(--ins-color);" title="Healthy">●</span>
                {% elif instance.connection_status == 'unhealthy' %}
                <span style="color: var(--del-color);" title="Unhealthy">●</span>
                {% else %}
                <span style="color: var(--muted-color);" title="Unknown">●</span>
                {% endif %}
                <a href="/dashboard/instances" style="text-decoration: none;">{{ instance.name }}</a>
                <small style="color: var(--muted-color);">({{ instance.instance_type }})</small>
                <small style="color: var(--muted-color); margin-left: auto;">
                    {% if instance.last_connection_test %}
                    {{ instance.last_connection_test|timeago }}
                    {% else %}
                    never checked
                    {% endif %}
                </small>
            </div>
            {% endfor %}
            {% else %}
            <p style="color: var(--muted-color);">No instances configured. <a href="/dashboard/instances">Add one</a></p>
            {% endif %}
        </div>
    </article>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
// Load library stats on page load
(async function() {
    try {
        var response = await fetch('/api/library/stats');
        if (response.ok) {
            var data = await response.json();
            var total = document.getElementById('stat-library-total');
            var detail = document.getElementById('stat-library-detail');
            if (total) total.textContent = data.total_items;
            if (detail) detail.textContent = data.complete_count + ' complete \u00b7 ' + data.missing_count + ' missing';
        }
    } catch (e) {
        var detail = document.getElementById('stat-library-detail');
        if (detail) detail.textContent = 'Not available';
    }
})();

// Auto-refresh stats every 30 seconds
setInterval(async () => {
    try {
        const response = await fetch('/api/dashboard/stats');
        if (response.ok) {
            const stats = await response.json();
            const qTotal = document.getElementById('stat-queues-total');
            const qActive = document.getElementById('stat-queues-active');
            const sToday = document.getElementById('stat-searches-today');
            const sDetail = document.getElementById('stat-searches-detail');
            if (qTotal) qTotal.textContent = stats.search_queues.total;
            if (qActive) qActive.textContent = stats.search_queues.active + ' active';
            if (sToday) sToday.textContent = stats.searches.today;
            if (sDetail) sDetail.textContent = stats.searches.this_week + ' this week \u00b7 ' + stats.searches.success_rate + '% success rate';
            var grDetail = document.getElementById('stat-grab-rate');
            if (grDetail) {
                if (stats.searches.grab_rate !== undefined && stats.searches.grab_rate > 0) {
                    grDetail.textContent = stats.searches.grab_rate + '% grab rate';
                } else {
                    grDetail.textContent = '';
                }
            }
        }
    } catch (error) {
        console.error('Failed to refresh stats:', error);
    }
}, 30000);

// Auto-refresh system status every 60 seconds
var statusLastChecked = Date.now();

function updateTimestamp() {
    var el = document.getElementById('system-status-timestamp');
    if (!el) return;
    var seconds = Math.floor((Date.now() - statusLastChecked) / 1000);
    if (seconds < 5) el.textContent = 'Last checked: just now';
    else if (seconds < 60) el.textContent = 'Last checked: ' + seconds + 's ago';
    else el.textContent = 'Last checked: ' + Math.floor(seconds / 60) + 'm ago';
}

setInterval(updateTimestamp, 5000);

function buildStatusRow(inst) {
    var row = document.createElement('div');
    row.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;';

    var dot = document.createElement('span');
    if (inst.connection_status === 'healthy') {
        dot.style.color = 'var(--ins-color)';
        dot.title = 'Healthy';
    } else if (inst.connection_status === 'unhealthy') {
        dot.style.color = 'var(--del-color)';
        dot.title = 'Unhealthy';
    } else {
        dot.style.color = 'var(--muted-color)';
        dot.title = 'Unknown';
    }
    dot.textContent = '\u25cf';
    row.appendChild(dot);

    var name = document.createElement('a');
    name.href = '/dashboard/instances';
    name.style.textDecoration = 'none';
    name.textContent = inst.name;
    row.appendChild(name);

    var typeLabel = document.createElement('small');
    typeLabel.style.color = 'var(--muted-color)';
    typeLabel.textContent = '(' + inst.instance_type + ')';
    row.appendChild(typeLabel);

    var checked = document.createElement('small');
    checked.style.cssText = 'color: var(--muted-color); margin-left: auto;';
    checked.textContent = inst.last_connection_test ? 'checked' : 'never checked';
    row.appendChild(checked);

    if (inst.response_time_ms !== null && inst.response_time_ms !== undefined && inst.connection_status === 'healthy') {
        var latency = document.createElement('small');
        latency.style.cssText = 'color: var(--muted-color); margin-left: 0.25rem;';
        latency.textContent = inst.response_time_ms + 'ms';
        row.appendChild(latency);
    }

    if (inst.connection_status === 'unhealthy' && inst.connection_error) {
        dot.title = 'Unhealthy: ' + inst.connection_error;
    }
    if (inst.consecutive_failures > 0) {
        dot.title += ' (' + inst.consecutive_failures + ' consecutive failures)';
    }

    return row;
}

setInterval(async () => {
    try {
        const response = await fetch('/api/dashboard/system-status');
        if (response.ok) {
            const data = await response.json();
            statusLastChecked = Date.now();
            var content = document.getElementById('system-status-content');
            if (!content || !data.instances.length) return;

            content.replaceChildren();
            data.instances.forEach(function(inst) {
                content.appendChild(buildStatusRow(inst));
            });
        }
    } catch (error) {
        console.error('Failed to refresh system status:', error);
    }
}, 30000);

// Activity feed — poll every 15s
async function refreshActivity() {
    try {
        var response = await fetch('/api/dashboard/activity?limit=10');
        if (!response.ok) return;
        var data = await response.json();
        updateActivityTable(data.activity);
    } catch (e) {
        // silent fail — table keeps last known state
    }
}

function updateActivityTable(activities) {
    var tbody = document.getElementById('activity-tbody');
    if (!tbody || !activities) return;

    tbody.replaceChildren();

    if (activities.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 5;
        emptyCell.style.textAlign = 'center';
        emptyCell.style.color = 'var(--muted-color)';
        emptyCell.textContent = 'No recent activity';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    activities.forEach(function(item) {
        var row = document.createElement('tr');

        // Instance
        var instCell = document.createElement('td');
        var instLink = document.createElement('a');
        instLink.href = '/dashboard/instances';
        instLink.textContent = item.instance_name || '\u2014';
        instCell.appendChild(instLink);
        row.appendChild(instCell);

        // Strategy
        var stratCell = document.createElement('td');
        var stratCode = document.createElement('code');
        stratCode.textContent = item.strategy;
        stratCell.appendChild(stratCode);
        row.appendChild(stratCell);

        // Status
        var statusCell = document.createElement('td');
        var statusSpan = document.createElement('span');
        if (item.status === 'success') {
            statusSpan.style.color = 'var(--ins-color)';
            statusSpan.textContent = '\u2713 Completed';
        } else if (item.status === 'partial_success') {
            statusSpan.style.color = 'var(--ins-color)';
            statusSpan.textContent = '\u2713 Partial';
        } else if (item.status === 'failed') {
            statusSpan.style.color = 'var(--del-color)';
            statusSpan.textContent = '\u2717 Failed';
        } else {
            statusSpan.style.color = 'var(--muted-color)';
            statusSpan.textContent = item.status;
        }
        statusCell.appendChild(statusSpan);
        row.appendChild(statusCell);

        // Items
        var itemsCell = document.createElement('td');
        var text = '';
        if (item.searches_triggered) {
            text = item.searches_triggered + ' searched';
            if (item.items_found) {
                text += ' of ' + item.items_found + ' eligible';
            }
        } else {
            text = (item.items_found || 0) + ' eligible';
        }
        itemsCell.textContent = text;
        row.appendChild(itemsCell);

        // Time
        var timeCell = document.createElement('td');
        var timeSmall = document.createElement('small');
        if (item.started_at) {
            timeSmall.textContent = Splintarr.formatTimeAgo(item.started_at);
        }
        timeCell.appendChild(timeSmall);
        row.appendChild(timeCell);

        tbody.appendChild(row);
    });
}

setInterval(refreshActivity, 15000);
refreshActivity();

// Indexer Health — poll every 60s
var indexerHealthExpanded = false;
var INDEXER_TRUNCATE_LIMIT = 5;

function buildIndexerRow(idx) {
    var row = document.createElement('tr');

    // Name
    var nameCell = document.createElement('td');
    nameCell.textContent = idx.name;
    row.appendChild(nameCell);

    // Query Limit (e.g. "100/day", "50/hour", or "No limit")
    var limitCell = document.createElement('td');
    if (idx.query_limit) {
        var unit = idx.limits_unit || 'day';
        limitCell.textContent = idx.query_limit + '/' + unit;
    } else {
        limitCell.style.color = 'var(--muted-color)';
        limitCell.textContent = 'No limit';
    }
    row.appendChild(limitCell);

    // Queries Used (e.g. "42 of 100" or just "7")
    var usedCell = document.createElement('td');
    if (idx.query_limit) {
        usedCell.textContent = idx.queries_used + ' of ' + idx.query_limit;
        if (idx.queries_used >= idx.query_limit * 0.9) {
            usedCell.style.color = 'var(--del-color)';
        }
    } else {
        usedCell.textContent = String(idx.queries_used);
    }
    row.appendChild(usedCell);

    // Status
    var statusCell = document.createElement('td');
    var statusSpan = document.createElement('span');
    if (idx.is_disabled) {
        statusSpan.style.color = 'var(--del-color)';
        statusSpan.textContent = 'Disabled';
    } else {
        statusSpan.style.color = 'var(--ins-color)';
        statusSpan.textContent = 'Active';
    }
    statusCell.appendChild(statusSpan);
    row.appendChild(statusCell);

    return row;
}

async function refreshIndexerHealth() {
    try {
        var response = await fetch('/api/dashboard/indexer-health');
        if (!response.ok) return;
        var data = await response.json();
        var section = document.getElementById('indexer-health-section');
        if (!section) return;

        if (!data.configured) {
            section.style.display = 'none';
            return;
        }

        section.style.display = '';

        var tbody = document.getElementById('indexer-health-body');
        if (!tbody) return;
        tbody.replaceChildren();

        if (data.error) {
            var errRow = document.createElement('tr');
            var errCell = document.createElement('td');
            errCell.colSpan = 4;
            errCell.style.textAlign = 'center';
            errCell.style.color = 'var(--del-color)';
            errCell.textContent = data.error;
            errRow.appendChild(errCell);
            tbody.appendChild(errRow);
            return;
        }

        if (!data.indexers || data.indexers.length === 0) {
            var emptyRow = document.createElement('tr');
            var emptyCell = document.createElement('td');
            emptyCell.colSpan = 4;
            emptyCell.style.textAlign = 'center';
            emptyCell.style.color = 'var(--muted-color)';
            emptyCell.textContent = 'No enabled indexers found';
            emptyRow.appendChild(emptyCell);
            tbody.appendChild(emptyRow);
            return;
        }

        var indexers = data.indexers;
        var needsTruncation = indexers.length > INDEXER_TRUNCATE_LIMIT;
        var visibleCount = (needsTruncation && !indexerHealthExpanded)
            ? INDEXER_TRUNCATE_LIMIT
            : indexers.length;

        for (var i = 0; i < visibleCount; i++) {
            tbody.appendChild(buildIndexerRow(indexers[i]));
        }

        // Add "Show all / Show fewer" toggle row when truncated
        if (needsTruncation) {
            var toggleRow = document.createElement('tr');
            var toggleCell = document.createElement('td');
            toggleCell.colSpan = 4;
            toggleCell.style.textAlign = 'center';
            var toggleLink = document.createElement('a');
            toggleLink.href = '#';
            toggleLink.style.cursor = 'pointer';
            if (indexerHealthExpanded) {
                toggleLink.textContent = 'Show fewer';
            } else {
                toggleLink.textContent = 'Show all ' + indexers.length + ' indexers';
            }
            toggleLink.addEventListener('click', function(e) {
                e.preventDefault();
                indexerHealthExpanded = !indexerHealthExpanded;
                refreshIndexerHealth();
            });
            toggleCell.appendChild(toggleLink);
            toggleRow.appendChild(toggleCell);
            tbody.appendChild(toggleRow);
        }
    } catch (e) {
        // silent fail — widget keeps last known state
    }
}

setInterval(refreshIndexerHealth, 60000);
refreshIndexerHealth();
</script>
{% endblock %}
