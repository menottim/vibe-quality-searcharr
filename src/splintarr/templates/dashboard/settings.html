{% extends "base.html" %}

{% block title %}Settings - Splintarr{% endblock %}

{% block content %}
<hgroup>
    <h1>Settings</h1>
    <p>Manage your account and preferences</p>
</hgroup>

<!-- Account Information -->
<details open>
    <summary><strong>Account Information</strong></summary>
    <article>
        <dl>
            <dt>Username</dt>
            <dd>{{ user.username }}</dd>

            <dt>Role</dt>
            <dd>
                {% if user.is_superuser %}
                <span style="color: var(--primary);">Administrator</span>
                {% else %}
                User
                {% endif %}
            </dd>

            <dt>Account Created</dt>
            <dd>{{ user.created_at|datetime }}</dd>

            <dt>Last Login</dt>
            <dd>
                {% if user.last_login %}
                {{ user.last_login|datetime }}
                {% if user.last_login_ip %}
                from {{ user.last_login_ip }}
                {% endif %}
                {% else %}
                Never
                {% endif %}
            </dd>
        </dl>
    </article>
</details>

<!-- Change Password -->
<details>
    <summary><strong>Change Password</strong></summary>
    <article>
        <form id="changePasswordForm">
            <label for="current_password">
                Current Password
                <input type="password" id="current_password" name="current_password" required autocomplete="current-password">
            </label>

            <label for="new_password">
                New Password
                <input type="password" id="new_password" name="new_password" required minlength="12" autocomplete="new-password">
                <small>Minimum 12 characters, must include uppercase, lowercase, digit, and special character</small>
            </label>

            <label for="confirm_new_password">
                Confirm New Password
                <input type="password" id="confirm_new_password" name="confirm_new_password" required minlength="12" autocomplete="new-password">
            </label>

            <button type="submit" id="changePasswordBtn">Change Password</button>
        </form>
    </article>
</details>

<!-- Two-Factor Authentication -->
<details>
    <summary><strong>Two-Factor Authentication</strong></summary>
    <article>
        <p>
            <small>Add an extra layer of security to your account by requiring a code from your authenticator app during login.</small>
        </p>
        <p>
            <small style="color: var(--muted-color);">
                <strong>Note:</strong> This 2FA implementation is AI-generated and has not been independently verified by security experts.
                See the <a href="https://github.com/menottim/splintarr#ai-generated-code-warning" target="_blank" rel="noopener">project README</a> for details.
            </small>
        </p>

        {% if user.totp_enabled %}
        <p><mark>Enabled</mark></p>
        <details>
            <summary role="button" class="secondary outline" style="color: var(--del-color);">Disable 2FA</summary>
            <form id="disable2faForm" style="margin-top: 1rem;">
                <label for="disable_2fa_password">
                    Password
                    <input type="password" id="disable_2fa_password" required autocomplete="current-password">
                </label>
                <label for="disable_2fa_code">
                    Authenticator Code
                    <input type="text" id="disable_2fa_code" required inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="Enter 6-digit code" autocomplete="one-time-code">
                </label>
                <button type="submit" id="disable2faBtn" style="color: var(--del-color);">Disable 2FA</button>
            </form>
        </details>
        {% else %}
        <div id="setup2faSection">
            <button id="enable2faBtn" class="secondary">Enable 2FA</button>
        </div>
        <div id="setup2faQR" style="display: none;">
            <p><strong>Scan this QR code with your authenticator app:</strong></p>
            <img id="qrCodeImg" alt="TOTP QR Code" style="max-width: 256px; margin: 1rem 0;">
            <details>
                <summary>Manual entry key</summary>
                <code id="manualSecret" style="word-break: break-all;"></code>
            </details>
            <form id="verify2faForm" style="margin-top: 1rem;">
                <label for="verify_2fa_code">
                    Enter the code from your authenticator app to verify:
                    <input type="text" id="verify_2fa_code" required inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="Enter 6-digit code" autocomplete="one-time-code">
                </label>
                <button type="submit" id="verify2faBtn">Verify and Enable</button>
            </form>
        </div>
        {% endif %}
    </article>
</details>

<!-- Notifications -->
<details>
    <summary><strong>Notifications</strong></summary>
    <article>
        <p>
            <small>Receive Discord notifications for search events, queue failures, and instance health changes.</small>
        </p>

        <form id="notificationForm">
            <label for="webhook_url">
                Discord Webhook URL
                <input type="password" id="webhook_url" name="webhook_url" placeholder="https://discord.com/api/webhooks/..." autocomplete="off">
                <small>Paste your Discord channel webhook URL. It will be encrypted before storage.</small>
            </label>

            <fieldset>
                <legend>Events</legend>
                <label>
                    <input type="checkbox" id="evt_search_triggered" name="search_triggered" checked>
                    Search completed (items found)
                </label>
                <label>
                    <input type="checkbox" id="evt_queue_failed" name="queue_failed" checked>
                    Queue failed
                </label>
                <label>
                    <input type="checkbox" id="evt_instance_health" name="instance_health" checked>
                    Instance health change
                </label>
                <label>
                    <input type="checkbox" id="evt_library_sync" name="library_sync" checked>
                    Library sync completed
                </label>
            </fieldset>

            <label>
                <input type="checkbox" id="notifications_active" name="is_active" checked>
                Enable notifications
            </label>

            <div class="grid">
                <button type="submit" id="saveNotificationsBtn">Save</button>
                <button type="button" id="testNotificationBtn" class="secondary">Test Notification</button>
            </div>
        </form>

        <small id="notificationStatus" style="display: none; margin-top: 0.5rem;"></small>
    </article>
</details>

<!-- Prowlarr Integration -->
<details>
    <summary><strong>Prowlarr Integration</strong></summary>
    <article>
        <p>
            <small>Connect Prowlarr for indexer-aware rate limiting. Splintarr will sync indexer data and respect per-indexer query limits.</small>
        </p>

        <div id="prowlarr-config">
            <small id="prowlarrStatus" style="display: none; margin-bottom: 0.5rem;"></small>
        </div>

        <form id="prowlarrForm">
            <label for="prowlarr_url">
                Prowlarr URL
                <input type="url" id="prowlarr_url" placeholder="http://prowlarr:9696" required>
                <small>Base URL of your Prowlarr instance. It will be validated for SSRF protection.</small>
                <small>For Docker: try <code>http://prowlarr:9696</code> (same Docker network) or <code>http://host.docker.internal:9696</code> (host machine)</small>
            </label>

            <label for="prowlarr_api_key">
                API Key
                <input type="password" id="prowlarr_api_key" placeholder="Enter Prowlarr API key" required minlength="10" autocomplete="off">
                <small>Found in Prowlarr under Settings &rarr; General &rarr; API Key. Will be encrypted before storage.</small>
            </label>

            <label>
                <input type="checkbox" id="prowlarr_verify_ssl" checked>
                Verify SSL
            </label>

            <label for="prowlarr_sync_interval">
                Sync Interval (minutes)
                <input type="number" id="prowlarr_sync_interval" min="5" max="1440" value="60">
                <small>How often to refresh indexer data from Prowlarr (5 min to 24 hours).</small>
            </label>

            <div class="grid">
                <button type="submit" id="saveProwlarrBtn">Save</button>
                <button type="button" id="testProwlarrBtn" class="secondary">Test Connection</button>
            </div>
        </form>

        <div id="prowlarrDangerZone" style="display: none; margin-top: 1rem;">
            <hr>
            <button type="button" id="deleteProwlarrBtn" class="secondary outline" style="color: var(--del-color);">Remove Prowlarr Configuration</button>
        </div>

        <small id="prowlarrActionStatus" style="display: none; margin-top: 0.5rem;"></small>
    </article>
</details>

<!-- System -->
<details>
    <summary><strong>System</strong></summary>
    <article>
        <h4>Config Export</h4>
        <p>Download your configuration (instances, queues, exclusions, notification settings) as JSON. API keys and webhook URLs are redacted.</p>
        <button id="exportConfigBtn" class="secondary">Download Config Export</button>

        <hr>

        <h4>Database Integrity</h4>
        <p>Run a database integrity check to verify your data is not corrupted.</p>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button id="integrityCheckBtn" class="secondary">Run Integrity Check</button>
            <small id="integrityResult" style="display: none;"></small>
        </div>
    </article>
</details>

<!-- Danger Zone -->
<details>
    <summary><strong style="color: var(--del-color);">Danger Zone</strong></summary>
    <article style="border-color: var(--del-color);">
        <p>
            <strong>Logout All Sessions</strong><br>
            <small>Revoke all active sessions and refresh tokens. You'll need to log in again on all devices.</small>
        </p>
        <button class="secondary" style="color: var(--del-color);" data-action="logout-all">Logout All Sessions</button>
    </article>
</details>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    var action = target.dataset.action;
    if (action === 'logout-all') logoutAllSessions();
});

document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_new_password').value;

    if (newPassword !== confirmPassword) {
        Splintarr.showNotification('New passwords do not match');
        return;
    }

    const submitBtn = document.getElementById('changePasswordBtn');
    submitBtn.disabled = true;
    submitBtn.setAttribute('aria-busy', 'true');

    try {
        const response = await fetch('/api/auth/password/change', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });

        if (response.ok) {
            Splintarr.showNotification('Password changed successfully! Redirecting to login...', 'success');
            setTimeout(function() { window.location.href = '/login'; }, 1500);
        } else {
            const data = await response.json();
            Splintarr.showNotification('Failed to change password: ' + (data.detail || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.setAttribute('aria-busy', 'false');
        }
    } catch (error) {
        Splintarr.showNotification('Failed to change password: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.setAttribute('aria-busy', 'false');
    }
});

// 2FA setup
var enable2faBtn = document.getElementById('enable2faBtn');
if (enable2faBtn) {
    enable2faBtn.addEventListener('click', async function() {
        enable2faBtn.disabled = true;
        enable2faBtn.setAttribute('aria-busy', 'true');

        try {
            var response = await fetch('/api/auth/2fa/setup', {
                method: 'POST'
            });

            if (response.ok) {
                var data = await response.json();
                document.getElementById('qrCodeImg').src = data.qr_code_data_uri;
                document.getElementById('manualSecret').textContent = data.secret;
                document.getElementById('setup2faSection').style.display = 'none';
                document.getElementById('setup2faQR').style.display = 'block';
                document.getElementById('verify_2fa_code').focus();
            } else {
                var data = await response.json();
                Splintarr.showNotification('Failed to setup 2FA: ' + (data.detail || 'Unknown error'));
                enable2faBtn.disabled = false;
                enable2faBtn.setAttribute('aria-busy', 'false');
            }
        } catch (error) {
            Splintarr.showNotification('Failed to setup 2FA: ' + error.message);
            enable2faBtn.disabled = false;
            enable2faBtn.setAttribute('aria-busy', 'false');
        }
    });
}

// 2FA verify (complete setup)
var verify2faForm = document.getElementById('verify2faForm');
if (verify2faForm) {
    verify2faForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        var submitBtn = document.getElementById('verify2faBtn');
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');

        var code = document.getElementById('verify_2fa_code').value;

        try {
            var response = await fetch('/api/auth/2fa/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });

            if (response.ok) {
                Splintarr.showNotification('Two-factor authentication enabled successfully!', 'success');
                setTimeout(function() { window.location.reload(); }, 1500);
            } else {
                var data = await response.json();
                Splintarr.showNotification('Verification failed: ' + (data.detail || 'Invalid code'));
                submitBtn.disabled = false;
                submitBtn.setAttribute('aria-busy', 'false');
                document.getElementById('verify_2fa_code').value = '';
                document.getElementById('verify_2fa_code').focus();
            }
        } catch (error) {
            Splintarr.showNotification('Verification failed: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.setAttribute('aria-busy', 'false');
        }
    });
}

// 2FA disable
var disable2faForm = document.getElementById('disable2faForm');
if (disable2faForm) {
    disable2faForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!confirm('Are you sure you want to disable two-factor authentication?')) {
            return;
        }

        var submitBtn = document.getElementById('disable2faBtn');
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');

        var password = document.getElementById('disable_2fa_password').value;
        var code = document.getElementById('disable_2fa_code').value;

        try {
            var response = await fetch('/api/auth/2fa/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password, code: code })
            });

            if (response.ok) {
                Splintarr.showNotification('Two-factor authentication disabled.', 'success');
                setTimeout(function() { window.location.reload(); }, 1500);
            } else {
                var data = await response.json();
                Splintarr.showNotification('Failed to disable 2FA: ' + (data.detail || 'Unknown error'));
                submitBtn.disabled = false;
                submitBtn.setAttribute('aria-busy', 'false');
            }
        } catch (error) {
            Splintarr.showNotification('Failed to disable 2FA: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.setAttribute('aria-busy', 'false');
        }
    });
}

async function logoutAllSessions() {
    if (!confirm('Are you sure you want to logout all sessions?\n\nYou will need to log in again on all devices.')) {
        return;
    }

    try {
        const response = await fetch('/api/auth/logout', {
            method: 'POST'
        });

        if (response.ok) {
            window.location.href = '/login';
        } else {
            Splintarr.showNotification('Failed to logout all sessions');
        }
    } catch (error) {
        Splintarr.showNotification('Failed to logout: ' + error.message);
    }
}

// ---------------------------------------------------------------
// Notifications
// ---------------------------------------------------------------

function showNotificationStatus(message, isError) {
    var el = document.getElementById('notificationStatus');
    el.textContent = message;
    el.style.display = 'block';
    el.style.color = isError ? 'var(--del-color)' : 'var(--ins-color)';
}

// Load existing notification config on page load
(async function loadNotificationConfig() {
    try {
        var response = await fetch('/api/notifications/config');
        if (response.ok) {
            var data = await response.json();
            document.getElementById('webhook_url').placeholder = data.webhook_url_masked;
            document.getElementById('evt_search_triggered').checked = data.events_enabled.search_triggered || false;
            document.getElementById('evt_queue_failed').checked = data.events_enabled.queue_failed || false;
            document.getElementById('evt_instance_health').checked = data.events_enabled.instance_health || false;
            document.getElementById('evt_library_sync').checked = data.events_enabled.library_sync || false;
            document.getElementById('notifications_active').checked = data.is_active;
        }
        // 404 is fine — means no config yet
    } catch (error) {
        // Ignore load errors — user may not have config yet
    }
})();

// Save notification config
document.getElementById('notificationForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    var webhookUrl = document.getElementById('webhook_url').value.trim();
    if (!webhookUrl) {
        Splintarr.showNotification('Please enter a Discord webhook URL');
        return;
    }

    var saveBtn = document.getElementById('saveNotificationsBtn');
    saveBtn.setAttribute('aria-busy', 'true');
    saveBtn.disabled = true;

    var payload = {
        webhook_url: webhookUrl,
        events_enabled: {
            search_triggered: document.getElementById('evt_search_triggered').checked,
            queue_failed: document.getElementById('evt_queue_failed').checked,
            instance_health: document.getElementById('evt_instance_health').checked,
            library_sync: document.getElementById('evt_library_sync').checked
        },
        is_active: document.getElementById('notifications_active').checked
    };

    try {
        var response = await fetch('/api/notifications/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            showNotificationStatus('Notification settings saved.', false);
            document.getElementById('webhook_url').value = '';
            document.getElementById('webhook_url').placeholder = '\u2022\u2022\u2022\u2022webhook';
        } else {
            var data = await response.json();
            showNotificationStatus('Failed to save: ' + (data.detail || 'Unknown error'), true);
        }
    } catch (error) {
        showNotificationStatus('Failed to save: ' + error.message, true);
    }

    saveBtn.removeAttribute('aria-busy');
    saveBtn.disabled = false;
});

// Test notification (auto-saves config first)
document.getElementById('testNotificationBtn').addEventListener('click', async function() {
    var btn = this;
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');

    var webhookUrl = document.getElementById('webhook_url').value.trim();
    if (!webhookUrl) {
        showNotificationStatus('Please enter a Discord webhook URL before testing.', true);
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        return;
    }

    // Step 1: Save config first
    showNotificationStatus('Saving...', false);

    var payload = {
        webhook_url: webhookUrl,
        events_enabled: {
            search_triggered: document.getElementById('evt_search_triggered').checked,
            queue_failed: document.getElementById('evt_queue_failed').checked,
            instance_health: document.getElementById('evt_instance_health').checked,
            library_sync: document.getElementById('evt_library_sync').checked
        },
        is_active: document.getElementById('notifications_active').checked
    };

    try {
        var saveResponse = await fetch('/api/notifications/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!saveResponse.ok) {
            var saveData = await saveResponse.json();
            showNotificationStatus('Save failed: ' + (saveData.detail || 'Unknown error'), true);
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            return;
        }

        // Clear webhook field and update placeholder after successful save
        document.getElementById('webhook_url').value = '';
        document.getElementById('webhook_url').placeholder = '\u2022\u2022\u2022\u2022webhook';
    } catch (error) {
        showNotificationStatus('Save failed: ' + error.message, true);
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        return;
    }

    // Step 2: Test notification
    showNotificationStatus('Testing...', false);

    try {
        var testResponse = await fetch('/api/notifications/test', {
            method: 'POST'
        });

        var testData = await testResponse.json();
        if (testResponse.ok) {
            showNotificationStatus('Test notification sent successfully!', false);
        } else {
            showNotificationStatus('Test failed: ' + (testData.detail || testData.message || 'Unknown error'), true);
        }
    } catch (error) {
        showNotificationStatus('Test failed: ' + error.message, true);
    }

    btn.disabled = false;
    btn.removeAttribute('aria-busy');
});

// ---------------------------------------------------------------
// Prowlarr Integration
// ---------------------------------------------------------------

function showProwlarrStatus(message, isError) {
    var el = document.getElementById('prowlarrActionStatus');
    el.textContent = message;
    el.style.display = 'block';
    el.style.color = isError ? 'var(--del-color)' : 'var(--ins-color)';
}

// Load existing Prowlarr config on page load
(async function loadProwlarrConfig() {
    try {
        var response = await fetch('/api/prowlarr/config');
        if (response.ok) {
            var data = await response.json();
            document.getElementById('prowlarr_url').value = data.url;
            document.getElementById('prowlarr_api_key').placeholder = data.api_key_masked;
            document.getElementById('prowlarr_api_key').required = false;
            document.getElementById('prowlarr_verify_ssl').checked = data.verify_ssl;
            document.getElementById('prowlarr_sync_interval').value = data.sync_interval_minutes;
            document.getElementById('prowlarrDangerZone').style.display = 'block';

            var statusEl = document.getElementById('prowlarrStatus');
            statusEl.style.display = 'block';
            statusEl.style.color = data.is_active ? 'var(--ins-color)' : 'var(--muted-color)';
            var statusText = data.is_active ? 'Connected' : 'Inactive';
            if (data.last_sync_at) {
                statusText += ' \u2014 Last sync: ' + new Date(data.last_sync_at).toLocaleString();
            }
            statusEl.textContent = statusText;
        }
        // 404 is fine — means no config yet
    } catch (error) {
        // Ignore load errors — user may not have config yet
    }
})();

// Save Prowlarr config
document.getElementById('prowlarrForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    var url = document.getElementById('prowlarr_url').value.trim();
    var apiKey = document.getElementById('prowlarr_api_key').value.trim();

    if (!url) {
        Splintarr.showNotification('Please enter a Prowlarr URL');
        return;
    }

    // API key is required on first save, optional on update (placeholder shows masked key)
    if (!apiKey && document.getElementById('prowlarr_api_key').required) {
        Splintarr.showNotification('Please enter a Prowlarr API key');
        return;
    }

    // If no new API key provided on update, we need to tell the user
    if (!apiKey) {
        Splintarr.showNotification('Please enter the API key again to update the configuration');
        return;
    }

    var saveBtn = document.getElementById('saveProwlarrBtn');
    saveBtn.setAttribute('aria-busy', 'true');
    saveBtn.disabled = true;

    var payload = {
        url: url,
        api_key: apiKey,
        verify_ssl: document.getElementById('prowlarr_verify_ssl').checked,
        sync_interval_minutes: parseInt(document.getElementById('prowlarr_sync_interval').value, 10) || 60
    };

    try {
        var response = await fetch('/api/prowlarr/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            showProwlarrStatus('Prowlarr configuration saved.', false);
            document.getElementById('prowlarr_api_key').value = '';
            document.getElementById('prowlarr_api_key').required = false;
            document.getElementById('prowlarrDangerZone').style.display = 'block';
            // Reload config to show masked key in placeholder
            var data = await response.json();
            document.getElementById('prowlarr_api_key').placeholder = data.api_key_masked;
        } else {
            var data = await response.json();
            showProwlarrStatus('Failed to save: ' + (data.detail || 'Unknown error'), true);
        }
    } catch (error) {
        showProwlarrStatus('Failed to save: ' + error.message, true);
    }

    saveBtn.removeAttribute('aria-busy');
    saveBtn.disabled = false;
});

// Test Prowlarr connection (auto-saves config first)
document.getElementById('testProwlarrBtn').addEventListener('click', async function() {
    var btn = this;
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');

    var url = document.getElementById('prowlarr_url').value.trim();
    var apiKey = document.getElementById('prowlarr_api_key').value.trim();

    if (!url) {
        showProwlarrStatus('Please enter a Prowlarr URL before testing.', true);
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        return;
    }

    if (!apiKey) {
        showProwlarrStatus('Please enter the API key before testing.', true);
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        return;
    }

    // Step 1: Save config first
    showProwlarrStatus('Saving...', false);

    var payload = {
        url: url,
        api_key: apiKey,
        verify_ssl: document.getElementById('prowlarr_verify_ssl').checked,
        sync_interval_minutes: parseInt(document.getElementById('prowlarr_sync_interval').value, 10) || 60
    };

    try {
        var saveResponse = await fetch('/api/prowlarr/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!saveResponse.ok) {
            var saveData = await saveResponse.json();
            showProwlarrStatus('Save failed: ' + (saveData.detail || 'Unknown error'), true);
            btn.disabled = false;
            btn.removeAttribute('aria-busy');
            return;
        }

        // Update UI after successful save
        var savedData = await saveResponse.json();
        document.getElementById('prowlarr_api_key').value = '';
        document.getElementById('prowlarr_api_key').required = false;
        document.getElementById('prowlarr_api_key').placeholder = savedData.api_key_masked;
        document.getElementById('prowlarrDangerZone').style.display = 'block';
    } catch (error) {
        showProwlarrStatus('Save failed: ' + error.message, true);
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        return;
    }

    // Step 2: Test connection
    showProwlarrStatus('Testing connection...', false);

    try {
        var testResponse = await fetch('/api/prowlarr/test', {
            method: 'POST'
        });

        var testData = await testResponse.json();
        if (testResponse.ok) {
            var details = [];
            if (testData.version) details.push('v' + testData.version);
            if (testData.response_time_ms) details.push(testData.response_time_ms + 'ms');
            var suffix = details.length ? ' (' + details.join(', ') + ')' : '';
            showProwlarrStatus('Connection successful!' + suffix, false);
        } else {
            showProwlarrStatus('Test failed: ' + (testData.detail || testData.message || testData.error || 'Unknown error'), true);
        }
    } catch (error) {
        showProwlarrStatus('Test failed: ' + error.message, true);
    }

    btn.disabled = false;
    btn.removeAttribute('aria-busy');
});

// Delete Prowlarr config
document.getElementById('deleteProwlarrBtn').addEventListener('click', async function() {
    if (!confirm('Are you sure you want to remove the Prowlarr configuration?\n\nIndexer-aware rate limiting will be disabled.')) {
        return;
    }

    var btn = this;
    btn.disabled = true;
    btn.setAttribute('aria-busy', 'true');

    try {
        var response = await fetch('/api/prowlarr/config', {
            method: 'DELETE'
        });

        if (response.ok) {
            showProwlarrStatus('Prowlarr configuration removed.', false);
            document.getElementById('prowlarr_url').value = '';
            document.getElementById('prowlarr_api_key').value = '';
            document.getElementById('prowlarr_api_key').placeholder = 'Enter Prowlarr API key';
            document.getElementById('prowlarr_api_key').required = true;
            document.getElementById('prowlarr_verify_ssl').checked = true;
            document.getElementById('prowlarr_sync_interval').value = '60';
            document.getElementById('prowlarrDangerZone').style.display = 'none';
            document.getElementById('prowlarrStatus').style.display = 'none';
        } else {
            var data = await response.json();
            showProwlarrStatus('Failed to remove: ' + (data.detail || 'Unknown error'), true);
        }
    } catch (error) {
        showProwlarrStatus('Failed to remove: ' + error.message, true);
    }

    btn.disabled = false;
    btn.removeAttribute('aria-busy');
});

// ---------------------------------------------------------------
// System — Config Export & Integrity Check
// ---------------------------------------------------------------

document.getElementById('exportConfigBtn').addEventListener('click', async function() {
    this.setAttribute('aria-busy', 'true');
    try {
        var response = await fetch('/api/config/export');
        if (!response.ok) throw new Error('Export failed');
        var blob = await response.blob();
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'splintarr-config-' + new Date().toISOString().slice(0, 10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
    } catch (err) {
        Splintarr.showNotification('Export failed: ' + err.message);
    } finally {
        this.removeAttribute('aria-busy');
    }
});

document.getElementById('integrityCheckBtn').addEventListener('click', async function() {
    this.setAttribute('aria-busy', 'true');
    var resultEl = document.getElementById('integrityResult');
    resultEl.style.display = 'none';
    try {
        var response = await fetch('/api/config/integrity-check', { method: 'POST' });
        var data = await response.json();
        resultEl.style.display = 'inline';
        if (data.status === 'ok') {
            resultEl.style.color = 'var(--ins-color)';
            resultEl.textContent = '\u2713 Database integrity OK';
        } else {
            resultEl.style.color = 'var(--del-color)';
            resultEl.textContent = '\u2717 Issues found: ' + data.details.join(', ');
        }
    } catch (err) {
        resultEl.style.display = 'inline';
        resultEl.style.color = 'var(--del-color)';
        resultEl.textContent = '\u2717 Check failed: ' + err.message;
    } finally {
        this.removeAttribute('aria-busy');
    }
});
</script>
{% endblock %}
