{% extends "base.html" %}

{% block title %}{{ item.title }} - Library - Splintarr{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ul>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/dashboard/library">Library</a></li>
        <li>{{ item.title }}</li>
    </ul>
</nav>

<!-- Item header -->
<div class="grid" style="grid-template-columns: auto 1fr; gap: 1.5rem; align-items: start;">
    <div style="width: 200px;">
        {% if item.poster_path %}
        <img src="/posters/{{ item.poster_path }}" alt="{{ item.title }}" style="width: 100%; border-radius: var(--border-radius);" />
        {% else %}
        <div class="poster-placeholder" style="width: 200px;">
            <svg viewBox="0 0 100 150" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="150" fill="#1a1a2e"/>
                <text x="50" y="70" text-anchor="middle" fill="#4a4a6a" font-size="10">No Poster</text>
                <text x="50" y="85" text-anchor="middle" fill="#4a4a6a" font-size="8">{{ item.content_type }}</text>
            </svg>
        </div>
        {% endif %}
    </div>
    <div>
        <hgroup>
            <h1>{{ item.title }}{% if item.year %} <small style="color: var(--muted-color);">({{ item.year }})</small>{% endif %}</h1>
            <p>
                {% if item.content_type == 'series' %}Series{% else %}Movie{% endif %}
                &middot;
                <a href="/dashboard/instances">{{ item.instance.name }}</a>
                {% if item.status %}
                &middot;
                <mark>{{ item.status }}</mark>
                {% endif %}
            </p>
        </hgroup>

        <article>
            <dl>
                <dt>Completion</dt>
                <dd>
                    <progress value="{{ item.episode_have }}" max="{{ item.episode_count }}" style="height: 6px;"></progress>
                    <span class="{% if item.is_complete %}text-success{% elif item.missing_count > 0 %}text-warning{% endif %}">
                        {{ item.episode_have }}/{{ item.episode_count }} ({{ item.completion_pct }}%)
                    </span>
                </dd>

                {% if item.missing_count > 0 %}
                <dt>Missing</dt>
                <dd class="text-warning">{{ item.missing_count }} {{ 'episodes' if item.content_type == 'series' else 'file' }}</dd>
                {% endif %}

                {% if item.quality_profile %}
                <dt>Quality Profile</dt>
                <dd>{{ item.quality_profile }}</dd>
                {% endif %}

                {% if item.last_synced_at %}
                <dt>Last Synced</dt>
                <dd>{{ item.last_synced_at|datetime }}</dd>
                {% endif %}

                {% if item.added_at %}
                <dt>Added</dt>
                <dd>{{ item.added_at|datetime }}</dd>
                {% endif %}
            </dl>
        </article>
    </div>
</div>

<!-- Episode breakdown (series only) -->
{% if item.content_type == 'series' and seasons %}
<article>
    <header><h3>Episodes</h3></header>

    {% for season_num, episodes in seasons.items() %}
    <details {% if loop.last %}open{% endif %} style="margin-bottom: 1rem;">
        <summary style="cursor: pointer;">
            <strong>Season {{ season_num }}</strong>
            {% set have = episodes|selectattr('has_file')|list|length %}
            {% set total = episodes|length %}
            <small style="color: var(--muted-color);">({{ have }}/{{ total }})</small>
        </summary>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
            {% for ep in episodes %}
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.5rem; border-radius: var(--border-radius); background: var(--card-background-color);">
                <span style="font-size: 0.75rem; font-weight: 600; min-width: 3rem; color: var(--muted-color);">{{ ep.episode_code }}</span>
                {% if ep.has_file %}
                <span style="color: var(--ins-color);">&#10003;</span>
                {% elif ep.monitored %}
                <span style="color: var(--del-color);">&#10007;</span>
                {% else %}
                <span style="color: var(--muted-color);">&#8211;</span>
                {% endif %}
                <span style="font-size: 0.8rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ ep.title or 'TBA' }}</span>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endfor %}
</article>
{% elif item.content_type == 'movie' %}
<article>
    <header><h3>Status</h3></header>
    <p>
        {% if item.is_complete %}
        <span style="color: var(--ins-color);">&#10003; Downloaded</span>
        {% else %}
        <span style="color: var(--del-color);">&#10007; Missing</span>
        {% endif %}
    </p>
</article>
{% endif %}

<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
    <a href="/dashboard/library" role="button" class="secondary">Back to Library</a>
    {% if is_excluded %}
    <span style="color: var(--del-color); align-self: center; font-weight: 600;">&#10007; Excluded from searches</span>
    {% else %}
    <button class="contrast outline" data-action="open-exclude-dialog">Exclude from Searches</button>
    {% endif %}
</div>

<!-- Exclude dialog -->
<dialog id="exclude-dialog">
    <article style="max-width: 480px;">
        <header>
            <button aria-label="Close" rel="prev" data-action="close-exclude-dialog"></button>
            <h3>Exclude "{{ item.title }}"</h3>
        </header>
        <p>This will prevent automated searches from triggering for this title.</p>
        <label for="exclude-reason">Reason (optional)</label>
        <input type="text" id="exclude-reason" maxlength="500" placeholder="e.g. Not available in my region" />
        <label for="exclude-duration">Duration</label>
        <select id="exclude-duration">
            <option value="permanent">Permanent</option>
            <option value="7d">7 days</option>
            <option value="30d">30 days</option>
            <option value="90d">90 days</option>
        </select>
        <footer>
            <button class="secondary" data-action="close-exclude-dialog">Cancel</button>
            <button id="exclude-confirm-btn" data-action="confirm-exclude">Exclude</button>
        </footer>
    </article>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
(function() {
    var dialog = document.getElementById('exclude-dialog');
    if (!dialog) return;

    document.addEventListener('click', function(e) {
        var target = e.target.closest('[data-action]');
        if (!target) return;
        if (target.dataset.action === 'open-exclude-dialog') {
            dialog.showModal();
        } else if (target.dataset.action === 'close-exclude-dialog') {
            dialog.close();
        } else if (target.dataset.action === 'confirm-exclude') {
            excludeItem();
        }
    });

    async function excludeItem() {
        var btn = document.getElementById('exclude-confirm-btn');
        btn.setAttribute('aria-busy', 'true');
        btn.disabled = true;

        var reason = document.getElementById('exclude-reason').value.trim() || null;
        var duration = document.getElementById('exclude-duration').value;

        try {
            var response = await fetch('/api/exclusions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instance_id: {{ item.instance_id }},
                    external_id: {{ item.external_id }},
                    content_type: '{{ item.content_type }}',
                    title: {{ item.title|tojson }},
                    library_item_id: {{ item.id }},
                    reason: reason,
                    duration: duration
                })
            });

            if (response.ok) {
                dialog.close();
                showNotification('Item excluded from searches.', 'success');
                setTimeout(function() { location.reload(); }, 1000);
            } else {
                var data = await response.json();
                showNotification('Failed: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            showNotification('Failed: ' + error.message);
        } finally {
            btn.setAttribute('aria-busy', 'false');
            btn.disabled = false;
        }
    }
})();
</script>
