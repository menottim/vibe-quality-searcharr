{% extends "base.html" %}

{% block title %}Library - Splintarr{% endblock %}

{% block content %}
<hgroup>
    <h1>Library</h1>
    <p>{{ stats.total_items }} items &middot; {{ stats.complete_count }} complete &middot; {{ stats.missing_count }} missing</p>
</hgroup>

<!-- Filters and actions -->
<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
    {% include "components/library_filters.html" %}

    <a href="/dashboard/library/missing" role="button" class="secondary" style="margin-bottom: 0;">Missing Only</a>

    {% if request.query_string %}
    <a href="{{ request.path }}" style="font-size: 0.875rem;">Clear filters</a>
    {% endif %}

    <button id="sync-btn" class="secondary" style="margin-left: auto; margin-bottom: 0;" data-action="sync-library">Refresh Library</button>
</div>

<!-- Poster grid -->
{% if items %}
<div class="poster-grid">
    {% for item in items %}
    <a href="/dashboard/library/{{ item.id }}" class="poster-card">
        {% if item.poster_path %}
        <img src="/posters/{{ item.poster_path }}" alt="{{ item.title }}" class="poster-img" loading="lazy" />
        {% else %}
        <div class="poster-placeholder">
            <svg viewBox="0 0 100 150" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="150" fill="#252832"/>
                <text x="50" y="70" text-anchor="middle" fill="#5a6169" font-size="10">No Poster</text>
                <text x="50" y="85" text-anchor="middle" fill="#5a6169" font-size="8">{{ item.content_type }}</text>
            </svg>
        </div>
        {% endif %}
        <div class="poster-info">
            <div class="poster-title">
                {{ item.title }}
                {% if excluded_set and (item.external_id, item.content_type) in excluded_set %}
                <span style="color: var(--del-color); font-size: 0.7rem; font-weight: 600;" title="Excluded from searches">&#10007; excluded</span>
                {% endif %}
            </div>
            {% if item.year %}<div class="poster-year">{{ item.year }}</div>{% endif %}
            <div class="poster-progress">
                <progress value="{{ item.episode_have }}" max="{{ item.episode_count }}" style="height: 4px; margin: 0;"></progress>
                <small class="{% if item.is_complete %}text-success{% elif item.missing_count > 0 %}text-warning{% endif %}">
                    {{ item.completion_pct }}%
                </small>
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<article>
    <p class="empty-state">
        {% if stats.total_items == 0 %}
        No library data yet. Click <strong>Refresh Library</strong> to sync from your instances, or <a href="/dashboard/instances">add an instance</a> first.
        {% else %}
        No items match the current filters.
        {% endif %}
    </p>
</article>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
function applyFilters() {
    var params = new URLSearchParams();
    var inst = document.getElementById('filter-instance').value;
    var type = document.getElementById('filter-type').value;
    if (inst) params.set('instance_id', inst);
    if (type) params.set('content_type', type);
    var qs = params.toString();
    window.location.href = '/dashboard/library' + (qs ? '?' + qs : '');
}

document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    if (target.dataset.action === 'sync-library') syncLibrary();
});

async function syncLibrary() {
    var btn = document.getElementById('sync-btn');
    btn.setAttribute('aria-busy', 'true');
    btn.disabled = true;
    btn.textContent = 'Syncing...';
    try {
        var response = await fetch('/api/library/sync', { method: 'POST' });
        if (!response.ok) {
            var data = await response.json();
            showNotification('Sync failed: ' + (data.detail || 'Unknown error'));
            btn.setAttribute('aria-busy', 'false');
            btn.disabled = false;
            btn.textContent = 'Refresh Library';
            return;
        }
    } catch (error) {
        showNotification('Sync failed: ' + error.message);
        btn.setAttribute('aria-busy', 'false');
        btn.disabled = false;
        btn.textContent = 'Refresh Library';
        return;
    }

    // Build fullscreen overlay using safe DOM methods
    var overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';

    var article = document.createElement('article');
    article.setAttribute('aria-busy', 'true');
    article.style.cssText = 'max-width:400px;width:90%;text-align:center;margin:0;';

    var heading = document.createElement('p');
    heading.textContent = 'Syncing library...';
    heading.style.cssText = 'font-size:1.25rem;font-weight:600;margin-bottom:0.5rem;';

    var detail = document.createElement('small');
    detail.textContent = 'This may take a few minutes for large libraries. Please wait.';

    article.appendChild(heading);
    article.appendChild(detail);
    overlay.appendChild(article);
    document.body.appendChild(overlay);

    // Poll sync status every 3 seconds
    var pollInterval = setInterval(async function() {
        try {
            var statusResp = await fetch('/api/library/sync-status');
            if (statusResp.ok) {
                var statusData = await statusResp.json();
                if (!statusData.syncing) {
                    clearInterval(pollInterval);
                    location.reload();
                }
            }
        } catch (e) {
            // Polling error â€” keep trying
        }
    }, 3000);
}
</script>
{% endblock %}
