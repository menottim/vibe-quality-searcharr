{% extends "base.html" %}

{% block title %}Library - Splintarr{% endblock %}

{% block content %}
<hgroup>
    <h1>Library</h1>
    <p>{{ stats.total_items }} items &middot; {{ stats.complete_count }} complete &middot; {{ stats.missing_count }} missing</p>
</hgroup>

<!-- Filters and actions -->
<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
    <select id="filter-instance" onchange="applyFilters()" style="max-width: 200px; margin-bottom: 0;">
        <option value="">All Instances</option>
        {% for inst in instances %}
        <option value="{{ inst.id }}" {{ 'selected' if selected_instance_id == inst.id else '' }}>{{ inst.name }}</option>
        {% endfor %}
    </select>

    <select id="filter-type" onchange="applyFilters()" style="max-width: 150px; margin-bottom: 0;">
        <option value="">All Types</option>
        <option value="series" {{ 'selected' if selected_content_type == 'series' else '' }}>Series</option>
        <option value="movie" {{ 'selected' if selected_content_type == 'movie' else '' }}>Movies</option>
    </select>

    <a href="/dashboard/library/missing" role="button" class="secondary" style="margin-bottom: 0;">Missing Only</a>

    <button id="sync-btn" class="secondary" style="margin-left: auto; margin-bottom: 0;" data-action="sync-library">Refresh Library</button>
</div>

<!-- Poster grid -->
{% if items %}
<div class="poster-grid">
    {% for item in items %}
    <a href="/dashboard/library/{{ item.id }}" class="poster-card">
        {% if item.poster_path %}
        <img src="/posters/{{ item.poster_path }}" alt="{{ item.title }}" class="poster-img" loading="lazy" />
        {% else %}
        <div class="poster-placeholder">
            <svg viewBox="0 0 100 150" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="150" fill="#1a1a2e"/>
                <text x="50" y="70" text-anchor="middle" fill="#4a4a6a" font-size="10">No Poster</text>
                <text x="50" y="85" text-anchor="middle" fill="#4a4a6a" font-size="8">{{ item.content_type }}</text>
            </svg>
        </div>
        {% endif %}
        <div class="poster-info">
            <div class="poster-title">{{ item.title }}</div>
            {% if item.year %}<div class="poster-year">{{ item.year }}</div>{% endif %}
            <div class="poster-progress">
                <progress value="{{ item.episode_have }}" max="{{ item.episode_count }}" style="height: 4px; margin: 0;"></progress>
                <small class="{% if item.is_complete %}text-success{% elif item.missing_count > 0 %}text-warning{% endif %}">
                    {{ item.completion_pct }}%
                </small>
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<article>
    <p class="empty-state">
        {% if stats.total_items == 0 %}
        No library data yet. Click <strong>Refresh Library</strong> to sync from your instances, or <a href="/dashboard/instances">add an instance</a> first.
        {% else %}
        No items match the current filters.
        {% endif %}
    </p>
</article>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
function applyFilters() {
    var params = new URLSearchParams();
    var inst = document.getElementById('filter-instance').value;
    var type = document.getElementById('filter-type').value;
    if (inst) params.set('instance_id', inst);
    if (type) params.set('content_type', type);
    var qs = params.toString();
    window.location.href = '/dashboard/library' + (qs ? '?' + qs : '');
}

document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    if (target.dataset.action === 'sync-library') syncLibrary();
});

async function syncLibrary() {
    var btn = document.getElementById('sync-btn');
    btn.setAttribute('aria-busy', 'true');
    btn.disabled = true;
    btn.textContent = 'Syncing...';
    try {
        var response = await fetch('/api/library/sync', { method: 'POST' });
        if (response.ok) {
            showNotification('Library sync started. This may take a few minutes.', 'success');
            setTimeout(function() { location.reload(); }, 30000);
        } else {
            var data = await response.json();
            showNotification('Sync failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        showNotification('Sync failed: ' + error.message);
    } finally {
        btn.setAttribute('aria-busy', 'false');
        btn.disabled = false;
        btn.textContent = 'Refresh Library';
    }
}
</script>
{% endblock %}
