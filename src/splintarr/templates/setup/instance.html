{% extends "base.html" %}

{% block title %}Add Instance - Splintarr{% endblock %}

{% block unauthenticated_content %}
<div class="setup-wizard-container">
    <!-- Progress indicator -->
    <div class="setup-progress">
        <span class="step completed" data-step="✓">Welcome</span>
        <span class="step completed" data-step="✓">Admin Account</span>
        <span class="step active" data-step="3">Instance</span>
        <span class="step" data-step="4">Notifications</span>
        <span class="step" data-step="5">Prowlarr</span>
        <span class="step" data-step="6">Complete</span>
    </div>

    <hgroup>
        <h1>Add Your First Instance</h1>
        <p>Connect to Sonarr or Radarr to start automating searches</p>
    </hgroup>

    <div class="setup-content">
        <article>
            <form action="/setup/instance" method="post" id="instanceForm">
                <div class="form-group">
                    <label for="instance_type">
                        Instance Type
                        <select id="instance_type" name="instance_type" required>
                            <option value="">Select type...</option>
                            <option value="sonarr" {% if instance_type == 'sonarr' %}selected{% endif %}>Sonarr (TV Shows)</option>
                            <option value="radarr" {% if instance_type == 'radarr' %}selected{% endif %}>Radarr (Movies)</option>
                        </select>
                    </label>
                </div>

                <div class="form-group">
                    <label for="name">
                        Instance Name
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            placeholder="e.g., Main Sonarr, 4K Radarr"
                            value="{{ name or '' }}">
                        <small>Friendly name to identify this instance</small>
                    </label>
                </div>

                <div class="form-group">
                    <label for="url">
                        URL
                        <input
                            type="url"
                            id="url"
                            name="url"
                            required
                            placeholder="http://localhost:8989"
                            value="{{ url or '' }}">
                        <small>Full URL including port (e.g., <code class="copy-url" title="Click to copy">http://localhost:8989</code> or <code class="copy-url" title="Click to copy">http://192.168.1.100:7878</code>)</small>
                    </label>
                    <div class="alert alert-info" style="margin-top: 0.75rem; font-size: 0.875rem;">
                        <strong>Docker Networking Tip:</strong> If <code>localhost</code> or your machine's IP
                        doesn't work inside Docker, try <code class="copy-url" title="Click to copy">http://host.docker.internal:8989</code> instead.
                    </div>
                </div>

                <div class="form-group">
                    <label for="api_key">
                        API Key
                        <input
                            type="text"
                            id="api_key"
                            name="api_key"
                            required
                            placeholder="Enter your API key"
                            autocomplete="off">
                        <small>Found in Settings > General > Security in Sonarr/Radarr</small>
                    </label>
                </div>

                <div id="testResult"></div>

                <div class="setup-actions">
                    <button type="button" class="secondary" id="testConnectionBtn">Test Connection</button>
                    <div class="btn-group">
                        <a href="/setup/instance/skip" role="button" class="secondary">Skip</a>
                        <button type="submit" id="submitBtn">Continue →</button>
                    </div>
                </div>
                <p style="margin-top: 1rem; text-align: center;">
                    <small><a href="https://github.com/menottim/splintarr#readme" target="_blank" rel="noopener">Need help?</a></small>
                </p>
            </form>
        </article>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
async function testConnection() {
    const testResult = document.getElementById('testResult');
    const instanceType = document.getElementById('instance_type').value;
    const url = document.getElementById('url').value;
    const apiKey = document.getElementById('api_key').value;

    if (!instanceType || !url || !apiKey) {
        const valAlert = document.createElement('div');
        valAlert.className = 'alert alert-danger';
        valAlert.style.marginTop = '1rem';
        valAlert.textContent = 'Please fill in all fields';
        testResult.replaceChildren(valAlert);
        return;
    }

    const loadAlert = document.createElement('div');
    loadAlert.className = 'alert alert-info';
    loadAlert.style.marginTop = '1rem';
    loadAlert.appendChild(document.createElement('progress'));
    loadAlert.appendChild(document.createTextNode(' Testing connection...'));
    testResult.replaceChildren(loadAlert);

    try {
        const response = await fetch('/api/instances/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                instance_type: instanceType,
                url: url,
                api_key: apiKey
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            const itemLabel = instanceType === 'sonarr' ? 'Series' : 'Movies';
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.style.marginTop = '1rem';
            const strong = document.createElement('strong');
            strong.textContent = '\u2713 Connection successful!';
            alert.appendChild(strong);
            alert.appendChild(document.createElement('br'));
            alert.appendChild(document.createTextNode('Version: ' + (data.version || 'Unknown')));
            if (data.instance_info) {
                alert.appendChild(document.createElement('br'));
                alert.appendChild(document.createTextNode('Instance: ' + data.instance_info));
            }
            alert.appendChild(document.createElement('br'));
            if (data.items_count != null) {
                alert.appendChild(document.createTextNode(itemLabel + ': ' + data.items_count));
            } else {
                alert.appendChild(document.createTextNode(itemLabel + ' count: unavailable '));
                const small = document.createElement('small');
                small.textContent = '(library count could not be retrieved, but the connection is working)';
                alert.appendChild(small);
            }
            testResult.replaceChildren(alert);
        } else {
            let errorMsg = data.message || '';
            if (!errorMsg && data.detail) {
                if (Array.isArray(data.detail)) {
                    errorMsg = data.detail.map(e => e.msg || e).join('; ');
                } else {
                    errorMsg = data.detail;
                }
            }
            errorMsg = errorMsg || 'Unknown error';
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.style.marginTop = '1rem';
            const strong = document.createElement('strong');
            strong.textContent = '\u2717 Connection failed:';
            alert.appendChild(strong);
            alert.appendChild(document.createTextNode(' ' + errorMsg));
            alert.appendChild(document.createElement('br'));
            const hint = document.createElement('small');
            hint.textContent = 'Check the Docker Networking Tip under the URL field if you\'re running inside Docker';
            alert.appendChild(hint);
            testResult.replaceChildren(alert);
        }
    } catch (error) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.style.marginTop = '1rem';
        const strong = document.createElement('strong');
        strong.textContent = '\u2717 Connection failed:';
        alert.appendChild(strong);
        alert.appendChild(document.createTextNode(' ' + error.message));
        alert.appendChild(document.createElement('br'));
        const hint = document.createElement('small');
        hint.textContent = 'See the Docker Networking Tip above if you\'re running inside Docker';
        alert.appendChild(hint);
        testResult.replaceChildren(alert);
    }
}

document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

// Auto-fill instance name when type changes
document.getElementById('instance_type').addEventListener('change', function() {
    var nameInput = document.getElementById('name');
    if (!nameInput.value || nameInput.value === 'sonarr-1' || nameInput.value === 'radarr-1') {
        nameInput.value = this.value ? this.value + '-1' : '';
    }
});

// Click-to-copy for example URLs
document.querySelectorAll('.copy-url').forEach(function(el) {
    el.style.cursor = 'pointer';
    el.style.borderBottom = '1px dashed var(--brand-info)';
    el.addEventListener('click', function() {
        var text = this.textContent;
        navigator.clipboard.writeText(text).then(function() {
            var orig = el.textContent;
            el.textContent = 'Copied!';
            el.style.color = 'var(--brand-success)';
            setTimeout(function() {
                el.textContent = orig;
                el.style.color = '';
            }, 1200);
        });
    });
});
</script>
{% endblock %}
