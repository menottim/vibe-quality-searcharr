{% extends "base.html" %}

{% block title %}Add Instance - Splintarr{% endblock %}

{% block unauthenticated_content %}
<div class="setup-wizard-container">
    <!-- Progress indicator -->
    <div class="setup-progress">
        <span class="step completed" data-step="✓">Welcome</span>
        <span class="step completed" data-step="✓">Admin Account</span>
        <span class="step active" data-step="3">Instance</span>
        <span class="step" data-step="4">Complete</span>
    </div>

    <hgroup>
        <h1>Add Your First Instance</h1>
        <p>Connect to Sonarr or Radarr to start automating searches</p>
    </hgroup>

    <div class="setup-content">
        <article>
            <form action="/setup/instance" method="post" id="instanceForm">
                <div class="form-group">
                    <label for="instance_type">
                        Instance Type
                        <select id="instance_type" name="instance_type" required>
                            <option value="">Select type...</option>
                            <option value="sonarr" {% if instance_type == 'sonarr' %}selected{% endif %}>Sonarr (TV Shows)</option>
                            <option value="radarr" {% if instance_type == 'radarr' %}selected{% endif %}>Radarr (Movies)</option>
                        </select>
                    </label>
                </div>

                <div class="form-group">
                    <label for="name">
                        Instance Name
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            placeholder="e.g., Main Sonarr, 4K Radarr"
                            value="{{ name or '' }}">
                        <small>Friendly name to identify this instance</small>
                    </label>
                </div>

                <div class="form-group">
                    <label for="url">
                        URL
                        <input
                            type="url"
                            id="url"
                            name="url"
                            required
                            placeholder="http://localhost:8989"
                            value="{{ url or '' }}">
                        <small>Full URL including port (e.g., <code class="copy-url" title="Click to copy">http://localhost:8989</code> or <code class="copy-url" title="Click to copy">http://192.168.1.100:7878</code>)</small>
                    </label>
                    <div class="alert alert-info" style="margin-top: 0.75rem; font-size: 0.875rem;">
                        <strong>Docker Networking Tip:</strong> If <code>localhost</code> or your machine's IP
                        doesn't work inside Docker, try <code class="copy-url" title="Click to copy">http://host.docker.internal:8989</code> instead.
                    </div>
                </div>

                <div class="form-group">
                    <label for="api_key">
                        API Key
                        <input
                            type="text"
                            id="api_key"
                            name="api_key"
                            required
                            placeholder="Enter your API key"
                            autocomplete="off">
                        <small>Found in Settings > General > Security in Sonarr/Radarr</small>
                    </label>
                </div>

                <div id="testResult"></div>

                <div class="setup-actions">
                    <button type="button" class="secondary" id="testConnectionBtn">Test Connection</button>
                    <div class="btn-group">
                        <a href="/setup/instance/skip" role="button" class="secondary">Skip</a>
                        <button type="submit" id="submitBtn">Continue →</button>
                    </div>
                </div>
                <p style="margin-top: 1rem; text-align: center;">
                    <small><a href="https://github.com/mminutillo/splintarr#readme" target="_blank" rel="noopener">Need help?</a></small>
                </p>
            </form>
        </article>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
async function testConnection() {
    const testResult = document.getElementById('testResult');
    const instanceType = document.getElementById('instance_type').value;
    const url = document.getElementById('url').value;
    const apiKey = document.getElementById('api_key').value;

    if (!instanceType || !url || !apiKey) {
        testResult.innerHTML = '<div class="alert alert-danger" style="margin-top: 1rem;">Please fill in all fields</div>';
        return;
    }

    testResult.innerHTML = '<div class="alert alert-info" style="margin-top: 1rem;"><progress></progress> Testing connection...</div>';

    try {
        const response = await fetch('/api/instances/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                instance_type: instanceType,
                url: url,
                api_key: apiKey
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            const itemLabel = instanceType === 'sonarr' ? 'Series' : 'Movies';
            let countLine;
            if (data.items_count != null) {
                countLine = `${escapeHtml(itemLabel)}: ${escapeHtml(data.items_count)}`;
            } else {
                countLine = `${escapeHtml(itemLabel)} count: unavailable <small>(library count could not be retrieved, but the connection is working)</small>`;
            }
            const infoLine = data.instance_info ? `<br>Instance: ${escapeHtml(data.instance_info)}` : '';
            testResult.innerHTML = `
                <div class="alert alert-success" style="margin-top: 1rem;">
                    <strong>✓ Connection successful!</strong><br>
                    Version: ${escapeHtml(data.version || 'Unknown')}${infoLine}<br>
                    ${countLine}
                </div>
            `;
        } else {
            let errorMsg = data.message || '';
            if (!errorMsg && data.detail) {
                if (Array.isArray(data.detail)) {
                    errorMsg = data.detail.map(e => e.msg || e).join('; ');
                } else {
                    errorMsg = data.detail;
                }
            }
            errorMsg = errorMsg || 'Unknown error';
            testResult.innerHTML = `
                <div class="alert alert-danger" style="margin-top: 1rem;">
                    <strong>✗ Connection failed:</strong> ${escapeHtml(errorMsg)}<br>
                    <small>Check the <strong>Docker Networking Tip</strong> under the URL field if you're running inside Docker</small>
                </div>
            `;
        }
    } catch (error) {
        testResult.innerHTML = `
            <div class="alert alert-danger" style="margin-top: 1rem;">
                <strong>✗ Connection failed:</strong> ${escapeHtml(error.message)}<br>
                <small>See the <strong>Docker Networking Tip</strong> above if you're running inside Docker</small>
            </div>
        `;
    }
}

document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

// Auto-fill instance name when type changes
document.getElementById('instance_type').addEventListener('change', function() {
    var nameInput = document.getElementById('name');
    if (!nameInput.value || nameInput.value === 'sonarr-1' || nameInput.value === 'radarr-1') {
        nameInput.value = this.value ? this.value + '-1' : '';
    }
});

// Click-to-copy for example URLs
document.querySelectorAll('.copy-url').forEach(function(el) {
    el.style.cursor = 'pointer';
    el.style.borderBottom = '1px dashed var(--brand-info)';
    el.addEventListener('click', function() {
        var text = this.textContent;
        navigator.clipboard.writeText(text).then(function() {
            var orig = el.textContent;
            el.textContent = 'Copied!';
            el.style.color = 'var(--brand-success)';
            setTimeout(function() {
                el.textContent = orig;
                el.style.color = '';
            }, 1200);
        });
    });
});
</script>
{% endblock %}
