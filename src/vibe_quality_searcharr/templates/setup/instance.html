{% extends "base.html" %}

{% block title %}Add Instance - Vibe-Quality-Searcharr{% endblock %}

{% block content %}
<div class="setup-wizard-container">
    <!-- Progress indicator -->
    <div class="setup-progress">
        <span class="step completed" data-step="✓">Welcome</span>
        <span class="step completed" data-step="✓">Admin Account</span>
        <span class="step active" data-step="3">Instance</span>
        <span class="step" data-step="4">Complete</span>
    </div>

    <hgroup>
        <h1>Add Your First Instance</h1>
        <p>Connect to Sonarr or Radarr to start automating searches</p>
    </hgroup>

    <div class="setup-content">
        <article>
            <form action="/setup/instance" method="post" id="instanceForm">
                <div class="form-group">
                    <label for="instance_type">
                        Instance Type
                        <select id="instance_type" name="instance_type" required>
                            <option value="">Select type...</option>
                            <option value="sonarr" {% if instance_type == 'sonarr' %}selected{% endif %}>Sonarr (TV Shows)</option>
                            <option value="radarr" {% if instance_type == 'radarr' %}selected{% endif %}>Radarr (Movies)</option>
                        </select>
                    </label>
                </div>

                <div class="form-group">
                    <label for="name">
                        Instance Name
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            placeholder="e.g., Main Sonarr, 4K Radarr"
                            value="{{ name or '' }}">
                        <small>Friendly name to identify this instance</small>
                    </label>
                </div>

                <div class="form-group">
                    <label for="url">
                        URL
                        <input
                            type="url"
                            id="url"
                            name="url"
                            required
                            placeholder="http://localhost:8989"
                            value="{{ url or '' }}">
                        <small>Full URL including port (e.g., http://localhost:8989 or http://192.168.1.100:7878)</small>
                    </label>
                    <details style="margin-top: 0.5rem;">
                        <summary><small><strong>Docker Networking Tips</strong></small></summary>
                        <ul style="margin-top: 0.5rem; font-size: 0.875rem;">
                            <li>
                                <strong>Don't use <code>localhost</code> or <code>127.0.0.1</code></strong><br>
                                <small style="color: #6b7280;">Inside Docker, these refer to the container, not your host machine</small>
                            </li>
                            <li>
                                <strong>Windows/Mac:</strong> Use <code>http://host.docker.internal:8989</code><br>
                                <small style="color: #6b7280;">This special hostname resolves to your host machine</small>
                            </li>
                            <li>
                                <strong>Linux:</strong> Use your machine's IP address (e.g., <code>http://192.168.1.100:8989</code>)<br>
                                <small style="color: #6b7280;">Find it with: <code>ip addr show</code> or <code>hostname -I</code></small>
                            </li>
                            <li>
                                <strong>Remote machine:</strong> Use the machine's IP or hostname<br>
                                <small style="color: #6b7280;">Make sure Sonarr/Radarr is configured to listen on all interfaces</small>
                            </li>
                        </ul>
                    </details>
                </div>

                <div class="form-group">
                    <label for="api_key">
                        API Key
                        <input
                            type="text"
                            id="api_key"
                            name="api_key"
                            required
                            placeholder="Enter your API key"
                            autocomplete="off">
                        <small>Found in Settings > General > Security in Sonarr/Radarr</small>
                    </label>
                </div>

                <div id="testResult"></div>

                <div class="setup-actions" style="margin-top: 1.5rem;">
                    <button type="button" class="secondary" id="testConnectionBtn">Test Connection</button>
                    <div class="btn-group">
                        <a href="/setup/instance/skip" role="button" class="secondary">Skip (Add Later)</a>
                        <button type="submit" id="submitBtn">Continue →</button>
                    </div>
                </div>
            </form>
        </article>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
async function testConnection() {
    const testResult = document.getElementById('testResult');
    const instanceType = document.getElementById('instance_type').value;
    const url = document.getElementById('url').value;
    const apiKey = document.getElementById('api_key').value;

    if (!instanceType || !url || !apiKey) {
        testResult.innerHTML = '<div class="alert alert-danger" style="margin-top: 1rem;">Please fill in all fields</div>';
        return;
    }

    testResult.innerHTML = '<div class="alert alert-info" style="margin-top: 1rem;"><progress></progress> Testing connection...</div>';

    try {
        const response = await fetch('/api/instances/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                instance_type: instanceType,
                url: url,
                api_key: apiKey
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            const itemLabel = instanceType === 'sonarr' ? 'Series' : 'Movies';
            let countLine;
            if (data.items_count != null) {
                countLine = `${itemLabel}: ${data.items_count}`;
            } else {
                countLine = `${itemLabel} count: unavailable <small>(library count could not be retrieved, but the connection is working)</small>`;
            }
            const infoLine = data.instance_info ? `<br>Instance: ${data.instance_info}` : '';
            testResult.innerHTML = `
                <div class="alert alert-success" style="margin-top: 1rem;">
                    <strong>✓ Connection successful!</strong><br>
                    Version: ${data.version || 'Unknown'}${infoLine}<br>
                    ${countLine}
                </div>
            `;
        } else {
            let errorMsg = data.message || '';
            if (!errorMsg && data.detail) {
                if (Array.isArray(data.detail)) {
                    errorMsg = data.detail.map(e => e.msg || e).join('; ');
                } else {
                    errorMsg = data.detail;
                }
            }
            errorMsg = errorMsg || 'Unknown error';
            testResult.innerHTML = `
                <div class="alert alert-danger" style="margin-top: 1rem;">
                    <strong>✗ Connection failed:</strong> ${errorMsg}<br>
                    <small>Check <strong>Docker Networking Tips</strong> under the URL field if you're using localhost</small>
                </div>
            `;
        }
    } catch (error) {
        testResult.innerHTML = `
            <div class="alert alert-danger" style="margin-top: 1rem;">
                <strong>✗ Connection failed:</strong> ${error.message}<br>
                <small>See <strong>Docker Networking Tips</strong> below if you're using localhost</small>
            </div>
        `;
    }
}

document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
</script>
{% endblock %}
