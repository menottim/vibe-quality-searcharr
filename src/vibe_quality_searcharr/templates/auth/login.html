{% extends "base.html" %}

{% block title %}Login - Vibe-Quality-Searcharr{% endblock %}

{% block unauthenticated_content %}
<div class="login-container">
    <article>
        <h1>Searcharr</h1>
        <p>Sign in to your account</p>

        <div id="loginError" class="alert alert-danger" style="display: none;" role="alert"></div>

        <form id="loginForm">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required autocomplete="username" autofocus>

            <label for="password">Password</label>
            <input type="password" id="password" name="password" required autocomplete="current-password">

            <button type="submit">Sign In</button>
        </form>
    </article>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
    const errorEl = document.getElementById('loginError');

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
    }

    function hideError() {
        errorEl.style.display = 'none';
    }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        hideError();
        const btn = this.querySelector('button[type="submit"]');
        btn.setAttribute('aria-busy', 'true');
        btn.textContent = 'Signing in...';

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                })
            });

            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                const data = await response.json();
                showError(data.detail || 'Login failed');
            }
        } catch (error) {
            showError('Connection error. Please try again.');
        } finally {
            btn.removeAttribute('aria-busy');
            btn.textContent = 'Sign In';
        }
    });
</script>
{% endblock %}
