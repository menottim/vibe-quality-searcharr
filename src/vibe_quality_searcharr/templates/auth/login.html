{% extends "base.html" %}

{% block title %}Login - Vibe-Quality-Searcharr{% endblock %}

{% block unauthenticated_content %}
<div class="login-container">
    <article>
        <h1>Searcharr</h1>
        <p id="loginSubtitle">Sign in to your account</p>

        <div id="loginError" class="alert alert-danger" style="display: none;" role="alert"></div>

        <form id="loginForm">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required autocomplete="username" autofocus>

            <label for="password">Password</label>
            <input type="password" id="password" name="password" required autocomplete="current-password">

            <button type="submit">Sign In</button>
        </form>

        <form id="totpForm" style="display: none;">
            <label for="totp_code">
                Authenticator Code
                <input type="text" id="totp_code" name="code" required autocomplete="one-time-code"
                       inputmode="numeric" pattern="\d{6}" maxlength="6"
                       placeholder="Enter 6-digit code">
            </label>

            <button type="submit" id="totpSubmitBtn">Verify</button>
            <a href="/login" role="button" class="secondary outline" style="margin-top: 0.5rem; display: block; text-align: center;">Use a different account</a>
        </form>
    </article>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
    const errorEl = document.getElementById('loginError');

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
    }

    function hideError() {
        errorEl.style.display = 'none';
    }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        hideError();
        const btn = this.querySelector('button[type="submit"]');
        btn.setAttribute('aria-busy', 'true');
        btn.textContent = 'Signing in...';

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                })
            });

            const data = await response.json();

            if (response.ok) {
                if (data.requires_2fa) {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('totpForm').style.display = 'block';
                    document.getElementById('loginSubtitle').textContent = 'Enter the code from your authenticator app';
                    document.getElementById('totp_code').focus();
                } else {
                    window.location.href = '/dashboard';
                }
            } else {
                showError(data.detail || 'Login failed');
            }
        } catch (error) {
            showError('Connection error. Please try again.');
        } finally {
            btn.removeAttribute('aria-busy');
            btn.textContent = 'Sign In';
        }
    });

    document.getElementById('totpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const submitBtn = document.getElementById('totpSubmitBtn');
        submitBtn.setAttribute('aria-busy', 'true');

        const code = document.getElementById('totp_code').value;

        try {
            const response = await fetch('/api/auth/2fa/login-verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            });

            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                const data = await response.json();
                showError(data.detail || 'Verification failed');
                submitBtn.removeAttribute('aria-busy');
                document.getElementById('totp_code').value = '';
                document.getElementById('totp_code').focus();
            }
        } catch (error) {
            showError('Verification failed: ' + error.message);
            submitBtn.removeAttribute('aria-busy');
        }
    });
</script>
{% endblock %}
